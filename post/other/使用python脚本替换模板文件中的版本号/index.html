<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta
        name="viewport"
        content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="keywords" content="pengjielee,个人博客" />
    <meta name="description" content="Pengjielee的个人博客" />
    <title>Pengjielee&#39;s blog</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700" />
    <link rel="stylesheet" href="/css/monokai-sublime.min.css" />
    <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
        <div id="main">
            <nav class="nav">
    <a href="/">首页</a> <span class="divide">|</span>
    <a href="/categories">分类</a>
    <span class="divide">|</span> <a href="/tags">标签</a>
    <span class="divide">|</span>
    <a href="/post">归档</a>
</nav>

    <div class="page page-single">
        <header class="header">
            <h1 class="title"></h1><div class="post-meta">
    <div class="date">0001-01-01</div>
</div>
</header>
        <div class="content" id="content"><h2 id="需求">需求</h2>
<p>后端模板文件引用前端资源，发布时，使用Python脚本自动替换前端资源的版本。</p>
<h2 id="准备工作">准备工作</h2>
<p>前端使用Webpack构建，每次构建完成时，会生成一个buildfile.json</p>
<p>buildfile.json</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;about.css&#34;</span>: <span style="color:#e6db74">&#34;about-ca3f85cec35d3ab39ac0.css&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;about.js&#34;</span>: <span style="color:#e6db74">&#34;about-613281148cb8885f2b3d.js&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;home.css&#34;</span>: <span style="color:#e6db74">&#34;home-94093b44a5a85be01f38.css&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;home.js&#34;</span>: <span style="color:#e6db74">&#34;home-6dd4e116818ee4945f65.js&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="读取前端构建文件">读取前端构建文件</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BUILD_FILES <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_build_files</span>():
</span></span><span style="display:flex;"><span>	build_file_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/Users/pengjie/try/iseo2/dist/buildfile.json&#39;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(build_file_path)):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">with</span> open(build_file_path,<span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> json<span style="color:#f92672">.</span>load(f)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		print(<span style="color:#e6db74">&#39;build file not exists.&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BUILD_FILES <span style="color:#f92672">=</span> get_build_files();
</span></span></code></pre></div><h2 id="获取所有模板文件">获取所有模板文件</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_template_files</span>():
</span></span><span style="display:flex;"><span>	template_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/Users/pengjie/try/iseo2/tmpviews&#39;</span>
</span></span><span style="display:flex;"><span>	template_files <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> dirpath, dirnames, filenames <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>walk(template_path):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> filename <span style="color:#f92672">in</span> filenames:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span>(filename[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;.&#39;</span>):
</span></span><span style="display:flex;"><span>				filepath <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(dirpath,filename)
</span></span><span style="display:flex;"><span>				template_files<span style="color:#f92672">.</span>append(filepath)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> template_files
</span></span></code></pre></div><h2 id="获取所有要替换的script和link">获取所有要替换的script和link</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_replace_list</span>(content):
</span></span><span style="display:flex;"><span>	replace_list <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>	soup <span style="color:#f92672">=</span> BeautifulSoup(content,<span style="color:#e6db74">&#39;html.parser&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 获取所有link</span>
</span></span><span style="display:flex;"><span>	links <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;link&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> links:
</span></span><span style="display:flex;"><span>		name <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>basename(item<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;href&#39;</span>))
</span></span><span style="display:flex;"><span>		matches <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\-(.+)?(\.)&#39;</span>,name,re<span style="color:#f92672">.</span>I)
</span></span><span style="display:flex;"><span>		key <span style="color:#f92672">=</span> name<span style="color:#f92672">.</span>replace(matches[<span style="color:#ae81ff">0</span>],<span style="color:#e6db74">&#39;.&#39;</span>)
</span></span><span style="display:flex;"><span>		replace_list<span style="color:#f92672">.</span>append({ <span style="color:#e6db74">&#39;old&#39;</span>: name, <span style="color:#e6db74">&#39;new&#39;</span>: BUILD_FILES<span style="color:#f92672">.</span>get(key,<span style="color:#e6db74">&#39;&#39;</span>)})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 获取所有script</span>
</span></span><span style="display:flex;"><span>	scripts <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;script&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> scripts:
</span></span><span style="display:flex;"><span>		name <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>basename(item<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;src&#39;</span>))
</span></span><span style="display:flex;"><span>		matches <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\-(.+)?(\.)&#39;</span>,name,re<span style="color:#f92672">.</span>I)
</span></span><span style="display:flex;"><span>		key <span style="color:#f92672">=</span> name<span style="color:#f92672">.</span>replace(matches[<span style="color:#ae81ff">0</span>],<span style="color:#e6db74">&#39;.&#39;</span>)
</span></span><span style="display:flex;"><span>		replace_list<span style="color:#f92672">.</span>append({ <span style="color:#e6db74">&#39;old&#39;</span>: name, <span style="color:#e6db74">&#39;new&#39;</span>: BUILD_FILES<span style="color:#f92672">.</span>get(key,<span style="color:#e6db74">&#39;&#39;</span>)})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> replace_list
</span></span></code></pre></div><h2 id="查找并替换">查找并替换</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">search_and_replace</span>(tplpath):
</span></span><span style="display:flex;"><span>	content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">with</span> open(tplpath,<span style="color:#e6db74">&#39;r&#39;</span>,encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>		content <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>		replace_list <span style="color:#f92672">=</span> get_replace_list(content)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> replace_list:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span>(item[<span style="color:#e6db74">&#39;old&#39;</span>] <span style="color:#f92672">and</span> item[<span style="color:#e6db74">&#39;new&#39;</span>]):
</span></span><span style="display:flex;"><span>				content <span style="color:#f92672">=</span> content<span style="color:#f92672">.</span>replace(item[<span style="color:#e6db74">&#39;old&#39;</span>],item[<span style="color:#e6db74">&#39;new&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">with</span> open(tplpath,<span style="color:#e6db74">&#34;w&#34;</span>,encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>		f<span style="color:#f92672">.</span>write(content)
</span></span></code></pre></div><h2 id="完整脚本内容">完整脚本内容</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BUILD_FILES <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>():
</span></span><span style="display:flex;"><span>	view_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/Users/pengjie/try/iseo2/tmpviews&#39;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> dirpath, dirnames, filenames <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>walk(view_path):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> filename <span style="color:#f92672">in</span> filenames:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span>(filename[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;.&#39;</span>):
</span></span><span style="display:flex;"><span>				filepath <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(dirpath,filename)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e"># 读取文件，获取替换列表</span>
</span></span><span style="display:flex;"><span>				content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">with</span> open(filepath,<span style="color:#e6db74">&#39;r&#39;</span>,encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>					content <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>					replace_list <span style="color:#f92672">=</span> get_replace_list(content)
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> replace_list:
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">if</span>(item[<span style="color:#e6db74">&#39;old&#39;</span>] <span style="color:#f92672">and</span> item[<span style="color:#e6db74">&#39;new&#39;</span>]):
</span></span><span style="display:flex;"><span>							content <span style="color:#f92672">=</span> content<span style="color:#f92672">.</span>replace(item[<span style="color:#e6db74">&#39;old&#39;</span>],item[<span style="color:#e6db74">&#39;new&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">with</span> open(filepath,<span style="color:#e6db74">&#34;w&#34;</span>,encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>					f<span style="color:#f92672">.</span>write(content)
</span></span><span style="display:flex;"><span>				print(<span style="color:#e6db74">&#39;----&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取替换列表</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_replace_list</span>(content):
</span></span><span style="display:flex;"><span>	replace_list <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>	soup <span style="color:#f92672">=</span> BeautifulSoup(content,<span style="color:#e6db74">&#39;html.parser&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 获取所有link</span>
</span></span><span style="display:flex;"><span>	links <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;link&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> links:
</span></span><span style="display:flex;"><span>		name <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>basename(item<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;href&#39;</span>))
</span></span><span style="display:flex;"><span>		matches <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\-(.+)?(\.)&#39;</span>,name,re<span style="color:#f92672">.</span>I)
</span></span><span style="display:flex;"><span>		key <span style="color:#f92672">=</span> name<span style="color:#f92672">.</span>replace(matches[<span style="color:#ae81ff">0</span>],<span style="color:#e6db74">&#39;.&#39;</span>)
</span></span><span style="display:flex;"><span>		replace_list<span style="color:#f92672">.</span>append({ <span style="color:#e6db74">&#39;old&#39;</span>: name, <span style="color:#e6db74">&#39;new&#39;</span>: BUILD_FILES<span style="color:#f92672">.</span>get(key,<span style="color:#e6db74">&#39;&#39;</span>)})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 获取所有script</span>
</span></span><span style="display:flex;"><span>	scripts <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;script&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> scripts:
</span></span><span style="display:flex;"><span>		name <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>basename(item<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;src&#39;</span>))
</span></span><span style="display:flex;"><span>		matches <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\-(.+)?(\.)&#39;</span>,name,re<span style="color:#f92672">.</span>I)
</span></span><span style="display:flex;"><span>		key <span style="color:#f92672">=</span> name<span style="color:#f92672">.</span>replace(matches[<span style="color:#ae81ff">0</span>],<span style="color:#e6db74">&#39;.&#39;</span>)
</span></span><span style="display:flex;"><span>		replace_list<span style="color:#f92672">.</span>append({ <span style="color:#e6db74">&#39;old&#39;</span>: name, <span style="color:#e6db74">&#39;new&#39;</span>: BUILD_FILES<span style="color:#f92672">.</span>get(key,<span style="color:#e6db74">&#39;&#39;</span>)})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> replace_list
</span></span><span style="display:flex;"><span>					
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取构建文件</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_build_file</span>():
</span></span><span style="display:flex;"><span>	build_file_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/Users/pengjie/try/iseo2/dist/buildfile.json&#39;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(build_file_path)):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">with</span> open(build_file_path,<span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> json<span style="color:#f92672">.</span>load(f)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		print(<span style="color:#e6db74">&#39;build file not exists.&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>	BUILD_FILES <span style="color:#f92672">=</span> get_build_file()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(BUILD_FILES):
</span></span><span style="display:flex;"><span>		run()
</span></span></code></pre></div></div>
        <div class="controls">
            <button id="increase">+</button>
            <button id="decrease">-</button>
        </div>
    </div>

        </div><script src="/js/highlight.min.js"></script>
<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", (event) => {
    		let size = 16;
    		const content = document.querySelector("#content");
        document.querySelectorAll("pre").forEach((block) => {
            hljs.highlightBlock(block);
        });
        document.querySelector("#increase").onclick = function(){
        	size++;
        	content.style.fontSize = `${size}px`;
        }
        document.querySelector("#decrease").onclick = function(){
        	size--;
        	content.style.fontSize = `${size}px`;
        }
    });
</script>
</body>
</html>
