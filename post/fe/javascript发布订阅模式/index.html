<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta
        name="viewport"
        content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="keywords" content="pengjielee,个人博客" />
    <meta name="description" content="Pengjielee的个人博客" />
    <title>Pengjielee&#39;s blog</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700" />
    <link rel="stylesheet" href="/css/monokai-sublime.min.css" />
    <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
        <div id="main">
            <nav class="nav">
    <a href="/">首页</a> <span class="divide">|</span>
    <a href="/categories">分类</a>
    <span class="divide">|</span> <a href="/tags">标签</a>
    <span class="divide">|</span>
    <a href="/post">归档</a>
</nav>

    <div class="page page-single">
        <header class="header">
            <h1 class="title">JavaScript发布订阅模式</h1><div class="post-meta">
    <div class="date">2021-04-06</div>
        <div class="tags">
            <label class="label">Tags：</label>
                <a class="link" href="/tags/javascript/" rel="tag">javascript</a>
        </div>
</div>
</header>
        <div class="content"><p>发布订阅模式，定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都将得到通知。在JS中，我们一般用事件模型来替代传统的发布-订阅模式。</p>
<h2 id="1-现实中的发布-订阅模式">1. 现实中的发布-订阅模式</h2>
<p>购房者与售楼处；</p>
<p>购房者：订阅者；
售楼处：发布者；</p>
<h2 id="2-发布-订阅模式的作用">2. 发布-订阅模式的作用</h2>
<p>发布-订阅模式优点：</p>
<p>a. 发布-订阅模式可以广泛应用于异步编程中，这是一种替代传递回调函数的方案。在异步编程中，使用发布-订阅模式，我们就无需过多关注对象在异步运行期间的内部状态，而只需要订阅感兴趣的事件发生点。</p>
<p>b. 发布-订阅模式可以取代对象之间硬编码的通知机制，一个对象不用再显式地调用另外一个对象的某个接口。让两个对象松耦合地联系在一起，虽然不太清楚彼此的细节，但这不影响它们之间相互通信。</p>
<h2 id="3-dom事件">3. DOM事件</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">//订阅body的click事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>document.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;click&#39;</span>,<span style="color:#66d9ef">function</span>(){ <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#ae81ff">2</span>) }, <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>document.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;click&#39;</span>,<span style="color:#66d9ef">function</span>(){ <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#ae81ff">3</span>) }, <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>document.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;click&#39;</span>,<span style="color:#66d9ef">function</span>(){ <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#ae81ff">4</span>) }, <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>document.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">click</span>(); <span style="color:#75715e">//模拟用户点击 
</span></span></span></code></pre></div><p>注意，手动触发事件更好的做法是 IE 下用 fireEvent，标准浏览器下用 dispatchEvent 实现。</p>
<h2 id="4-自定义事件">4. 自定义事件</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">salesOffices</span> <span style="color:#f92672">=</span> {}; <span style="color:#75715e">// 定义售楼处
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">clientList</span> <span style="color:#f92672">=</span> []; <span style="color:#75715e">// 缓存列表，存放订阅者的回调函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">listen</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">fn</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 增加订阅者
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientList</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">fn</span>); <span style="color:#75715e">// 订阅的消息添加进缓存列表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">trigger</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 发布消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">fn</span>; (<span style="color:#a6e22e">fn</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientList</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>]); ) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fn</span>.<span style="color:#a6e22e">apply</span>(<span style="color:#66d9ef">this</span>, <span style="color:#a6e22e">arguments</span>); <span style="color:#75715e">// (2) // arguments 是发布消息时带上的参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//下面我们来进行一些简单的测试：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">price</span>, <span style="color:#a6e22e">squareMeter</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 小明订阅消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;价格= &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">price</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;squareMeter= &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">squareMeter</span>);
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">price</span>, <span style="color:#a6e22e">squareMeter</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 小红订阅消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;价格= &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">price</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;squareMeter= &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">squareMeter</span>);
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">trigger</span>(<span style="color:#ae81ff">2000000</span>, <span style="color:#ae81ff">88</span>); <span style="color:#75715e">// 输出： 200 万， 88 平方米
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">trigger</span>(<span style="color:#ae81ff">3000000</span>, <span style="color:#ae81ff">110</span>); <span style="color:#75715e">// 输出： 300 万， 110 平方米
</span></span></span></code></pre></div><p>至此，我们已经实现了一个最简单的发布—订阅模式，但这里还存在一些问题。我们看到订阅者接收到了发布者发布的每个消息，虽然小明只想买 88 平方米的房子，但是发布者把 110 平方米的信息也推送给了小明，这对小明来说是不必要的困扰。所以我们有必要增加一个标示 key，让订阅者只订阅自己感兴趣的消息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">salesOffices</span> <span style="color:#f92672">=</span> {}; <span style="color:#75715e">// 定义售楼处
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">clientList</span> <span style="color:#f92672">=</span> {}; <span style="color:#75715e">// 缓存列表，存放订阅者的回调函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">listen</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientList</span>[<span style="color:#a6e22e">key</span>]) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果还没有订阅过此类消息，给该类消息创建一个缓存列表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientList</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientList</span>[<span style="color:#a6e22e">key</span>].<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">fn</span>); <span style="color:#75715e">// 订阅的消息添加进消息缓存列表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">trigger</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 发布消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> Array.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">shift</span>.<span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">arguments</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 取出消息类型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">fns</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientList</span>[<span style="color:#a6e22e">key</span>]; <span style="color:#75715e">// 取出该消息对应的回调函数集合
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">fns</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">fns</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果没有订阅该消息，则返回
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">fn</span>; (<span style="color:#a6e22e">fn</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fns</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>]); ) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fn</span>.<span style="color:#a6e22e">apply</span>(<span style="color:#66d9ef">this</span>, <span style="color:#a6e22e">arguments</span>); <span style="color:#75715e">// (2) // arguments 是发布消息时附送的参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#e6db74">&#34;squareMeter88&#34;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">price</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 小明订阅 88 平方米房子的消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;价格= &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">price</span>); <span style="color:#75715e">// 输出： 2000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>});
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#e6db74">&#34;squareMeter110&#34;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">price</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 小红订阅 110 平方米房子的消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;价格= &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">price</span>); <span style="color:#75715e">// 输出： 3000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>});
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">trigger</span>(<span style="color:#e6db74">&#34;squareMeter88&#34;</span>, <span style="color:#ae81ff">2000000</span>); <span style="color:#75715e">// 发布 88 平方米房子的价格
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">trigger</span>(<span style="color:#e6db74">&#34;squareMeter110&#34;</span>, <span style="color:#ae81ff">3000000</span>); <span style="color:#75715e">// 发布 110 平方米房子的价格
</span></span></span></code></pre></div><h2 id="5-发布-订阅模式的通用实现">5. 发布-订阅模式的通用实现</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">event</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">clientList</span><span style="color:#f92672">:</span> [],
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">listen</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientList</span>[<span style="color:#a6e22e">key</span>]) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientList</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientList</span>[<span style="color:#a6e22e">key</span>].<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">fn</span>); <span style="color:#75715e">// 订阅的消息添加进缓存列表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">trigger</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> Array.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">shift</span>.<span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">arguments</span>), <span style="color:#75715e">// (1);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">fns</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientList</span>[<span style="color:#a6e22e">key</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">fns</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">fns</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 如果没有绑定对应的消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">fn</span>; (<span style="color:#a6e22e">fn</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fns</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>]); ) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fn</span>.<span style="color:#a6e22e">apply</span>(<span style="color:#66d9ef">this</span>, <span style="color:#a6e22e">arguments</span>); <span style="color:#75715e">// (2) // arguments 是 trigger 时带上的参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//再定义一个installEvent函数，这个函数可以给所有的对象都动态安装发布—订阅功能：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">installEvent</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">obj</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">event</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">obj</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">event</span>[<span style="color:#a6e22e">i</span>];
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//再来测试一番，我们给售楼处对象 salesOffices 动态增加发布—订阅功能：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">salesOffices</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">installEvent</span>(<span style="color:#a6e22e">salesOffices</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#e6db74">&#34;squareMeter88&#34;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">price</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 小明订阅消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;价格= &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">price</span>);
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#e6db74">&#34;squareMeter100&#34;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">price</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 小红订阅消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;价格= &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">price</span>);
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">trigger</span>(<span style="color:#e6db74">&#34;squareMeter88&#34;</span>, <span style="color:#ae81ff">2000000</span>); <span style="color:#75715e">// 输出： 2000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">trigger</span>(<span style="color:#e6db74">&#34;squareMeter100&#34;</span>, <span style="color:#ae81ff">3000000</span>); <span style="color:#75715e">// 输出： 3000000
</span></span></span></code></pre></div><h2 id="6-取消订阅的事件">6. 取消订阅的事件</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">remove</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fns</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clientList</span>[<span style="color:#a6e22e">key</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">fns</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果 key 对应的消息没有被人订阅，则直接返回
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">fn</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果没有传入具体的回调函数，表示需要取消 key 对应消息的所有订阅
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">fns</span> <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">fns</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fns</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">l</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">l</span><span style="color:#f92672">--</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 反向遍历订阅的回调函数列表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_fn</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fns</span>[<span style="color:#a6e22e">l</span>];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">_fn</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">fn</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fns</span>.<span style="color:#a6e22e">splice</span>(<span style="color:#a6e22e">l</span>, <span style="color:#ae81ff">1</span>); <span style="color:#75715e">// 删除订阅者的回调函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">salesOffices</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">installEvent</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">obj</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">event</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">obj</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">event</span>[<span style="color:#a6e22e">i</span>];
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">installEvent</span>(<span style="color:#a6e22e">salesOffices</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">listen</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;squareMeter88&#34;</span>,
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">fn1</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">price</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 小明订阅消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;价格= &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">price</span>);
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">listen</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;squareMeter88&#34;</span>,
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">fn2</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">price</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 小红订阅消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;价格= &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">price</span>);
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">remove</span>(<span style="color:#e6db74">&#34;squareMeter88&#34;</span>, <span style="color:#a6e22e">fn1</span>); <span style="color:#75715e">// 删除小明的订阅
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">salesOffices</span>.<span style="color:#a6e22e">trigger</span>(<span style="color:#e6db74">&#34;squareMeter88&#34;</span>, <span style="color:#ae81ff">2000000</span>); <span style="color:#75715e">// 输出： 2000000
</span></span></span></code></pre></div><h2 id="7-真实例子--网站登录">7. 真实例子&ndash;网站登录</h2>
<p>假如我们正在开发一个商城网站，网站里有 header 头部、 nav 导航、消息列表、购物车等模块。这几个模块的渲染有一个共同的前提条件，就是必须先用 ajax 异步请求获取用户的登录信息。这是很正常的，比如用户的名字和头像要显示在 header 模块里，而这两个字段都来自用户登录后返回的信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">login</span>.<span style="color:#a6e22e">succ</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">data</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">header</span>.<span style="color:#a6e22e">setAvatar</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">avatar</span>); <span style="color:#75715e">// 设置 header 模块的头像
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">nav</span>.<span style="color:#a6e22e">setAvatar</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">avatar</span>); <span style="color:#75715e">// 设置导航模块的头像
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">refresh</span>(); <span style="color:#75715e">// 刷新消息列表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">cart</span>.<span style="color:#a6e22e">refresh</span>(); <span style="color:#75715e">// 刷新购物车列表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>});
</span></span></code></pre></div><p>当登录成功时，登录模块只需要发布登录成功的消息，而业务方接受到消息之后，就会开始进行各自的业务处理，登录模块并不关心业务方究竟要做什么，也不想去了解它们的内部细节。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">ajax</span>(<span style="color:#e6db74">&#34;http:// xxx.com?login&#34;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">data</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 登录成功
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">login</span>.<span style="color:#a6e22e">trigger</span>(<span style="color:#e6db74">&#34;loginSucc&#34;</span>, <span style="color:#a6e22e">data</span>); <span style="color:#75715e">// 发布登录成功的消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 各模块监听登录成功的消息：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">header</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// header 模块
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">login</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#e6db74">&#34;loginSucc&#34;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">data</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">header</span>.<span style="color:#a6e22e">setAvatar</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">avatar</span>);
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setAvatar</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">data</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;设置 header 模块的头像&#34;</span>);
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>})();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">nav</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// nav 模块
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">login</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#e6db74">&#34;loginSucc&#34;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">data</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">nav</span>.<span style="color:#a6e22e">setAvatar</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">avatar</span>);
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setAvatar</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">avatar</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;设置 nav 模块的头像&#34;</span>);
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>})();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//如果有一天在登录完成之后，又增加一个刷新收货地址列表的行为，那么只要在收货地址模块里加上监听消息的方法即可，而这可以让开发该模块的同事自己完成，你作为登录模块的开发者，永远不用再关心这些行为了。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">address</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// address 模块
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">login</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#e6db74">&#34;loginSucc&#34;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">obj</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">address</span>.<span style="color:#a6e22e">refresh</span>(<span style="color:#a6e22e">obj</span>);
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">refresh</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">avatar</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;刷新收货地址列表&#34;</span>);
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>})();
</span></span></code></pre></div><h2 id="8-全局的发布-订阅对象">8. 全局的发布-订阅对象</h2>
<p>发布—订阅模式可以用一个全局的 Event 对象来实现，订阅者不需要了解消息来自哪个发布者，发布者也不知道消息会推送给哪些订阅者， Event 作为一个类似“中介者”的角色，把订阅者和发布者联系起来。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">Event</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">clientList</span> <span style="color:#f92672">=</span> {},
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">listen</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">trigger</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">remove</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">listen</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">clientList</span>[<span style="color:#a6e22e">key</span>]) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">clientList</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">clientList</span>[<span style="color:#a6e22e">key</span>].<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">fn</span>);
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">trigger</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> Array.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">shift</span>.<span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">arguments</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fns</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">clientList</span>[<span style="color:#a6e22e">key</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">fns</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">fns</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">fn</span>; (<span style="color:#a6e22e">fn</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fns</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>]); ) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fn</span>.<span style="color:#a6e22e">apply</span>(<span style="color:#66d9ef">this</span>, <span style="color:#a6e22e">arguments</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">remove</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fns</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">clientList</span>[<span style="color:#a6e22e">key</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">fns</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">fn</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fns</span> <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">fns</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">l</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fns</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">l</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">l</span><span style="color:#f92672">--</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_fn</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fns</span>[<span style="color:#a6e22e">l</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">_fn</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">fn</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">fns</span>.<span style="color:#a6e22e">splice</span>(<span style="color:#a6e22e">l</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">listen</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">listen</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">trigger</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">trigger</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">remove</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">remove</span>,
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>})();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Event</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#e6db74">&#34;squareMeter88&#34;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">price</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 小红订阅消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;价格= &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">price</span>); <span style="color:#75715e">// 输出： &#39;价格=2000000&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>});
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Event</span>.<span style="color:#a6e22e">trigger</span>(<span style="color:#e6db74">&#34;squareMeter88&#34;</span>, <span style="color:#ae81ff">2000000</span>); <span style="color:#75715e">// 售楼处发布消息
</span></span></span></code></pre></div><h2 id="9-模块间通信">9. 模块间通信</h2>
<p>比如现在有两个模块， a 模块里面有一个按钮，每次点击按钮之后， b 模块里的 div 中会显示
按钮的总点击次数，我们用全局发布—订阅模式完成下面的代码，使得 a 模块和 b 模块可以在保
持封装性的前提下进行通信。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">button</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;count&#34;</span>&gt;点我&lt;/<span style="color:#f92672">button</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;show&#34;</span>&gt;&lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/JavaScript&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">function</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">count</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">button</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">getElementById</span>( <span style="color:#e6db74">&#39;count&#39;</span> );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">button</span>.<span style="color:#a6e22e">onclick</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(){
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Event</span>.<span style="color:#a6e22e">trigger</span>( <span style="color:#e6db74">&#39;add&#39;</span>, <span style="color:#a6e22e">count</span><span style="color:#f92672">++</span> );
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    })();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">function</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">div</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">getElementById</span>( <span style="color:#e6db74">&#39;show&#39;</span> );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Event</span>.<span style="color:#a6e22e">listen</span>( <span style="color:#e6db74">&#39;add&#39;</span>, <span style="color:#66d9ef">function</span>( <span style="color:#a6e22e">count</span> ){
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">div</span>.<span style="color:#a6e22e">innerHTML</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">count</span>;
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    })();
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><h2 id="10-必须先订阅再发布吗">10. 必须先订阅再发布吗</h2>
<p>我们所了解到的发布—订阅模式，都是订阅者必须先订阅一个消息，随后才能接收到发布者
发布的消息。如果把顺序反过来，发布者先发布一条消息，而在此之前并没有对象来订阅它，这
条消息无疑将消失在宇宙中。</p>
<p>在某些情况下，我们需要先将这条消息保存下来，等到有对象来订阅它的时候，再重新把消
息发布给订阅者。就如同 QQ 中的离线消息一样，离线消息被保存在服务器中，接收人下次登录
上线之后，可以重新收到这条消息。</p>
<p>为了满足这个需求，我们要建立一个存放离线事件的堆栈，当事件发布的时候，如果此时还
没有订阅者来订阅这个事件，我们暂时把发布事件的动作包裹在一个函数里，这些包装函数将被
存入堆栈中，等到终于有对象来订阅此事件的时候，我们将遍历堆栈并且依次执行这些包装函数，
也就是重新发布里面的事件。当然离线事件的生命周期只有一次，就像 QQ 的未读消息只会被重
新阅读一次，所以刚才的操作我们只能进行一次。</p>
<h2 id="11-全局事件的全名冲突">11. 全局事件的全名冲突</h2>
<p>全局的发布-订阅对象里只有一个clientList来存放消息名和回调函数，大家都通过它来订
阅和发布各种消息，久而久之，难免会出现事件名冲突的情况，所以我们还可以给 Event 对象提
供创建命名空间的功能。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">/************** 先发布后订阅 ********************/</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Event</span>.<span style="color:#a6e22e">trigger</span>(<span style="color:#e6db74">&#34;click&#34;</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Event</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#e6db74">&#34;click&#34;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">a</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">a</span>); <span style="color:#75715e">// 输出： 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>});
</span></span><span style="display:flex;"><span><span style="color:#75715e">/************** 使用命名空间 ********************/</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Event</span>.<span style="color:#a6e22e">create</span>(<span style="color:#e6db74">&#34;namespace1&#34;</span>).<span style="color:#a6e22e">listen</span>(<span style="color:#e6db74">&#34;click&#34;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">a</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">a</span>); <span style="color:#75715e">// 输出： 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>});
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Event</span>.<span style="color:#a6e22e">create</span>(<span style="color:#e6db74">&#34;namespace1&#34;</span>).<span style="color:#a6e22e">trigger</span>(<span style="color:#e6db74">&#34;click&#34;</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Event</span>.<span style="color:#a6e22e">create</span>(<span style="color:#e6db74">&#34;namespace2&#34;</span>).<span style="color:#a6e22e">listen</span>(<span style="color:#e6db74">&#34;click&#34;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">a</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">a</span>); <span style="color:#75715e">// 输出： 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>});
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Event</span>.<span style="color:#a6e22e">create</span>(<span style="color:#e6db74">&#34;namespace2&#34;</span>).<span style="color:#a6e22e">trigger</span>(<span style="color:#e6db74">&#34;click&#34;</span>, <span style="color:#ae81ff">2</span>);
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">Event</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">global</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Event</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_default</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;default&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Event</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_listen</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">_trigger</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">_remove</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">_slice</span> <span style="color:#f92672">=</span> Array.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">slice</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">_shift</span> <span style="color:#f92672">=</span> Array.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">shift</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">_unshift</span> <span style="color:#f92672">=</span> Array.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">unshift</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">namespaceCache</span> <span style="color:#f92672">=</span> {},
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">_create</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">find</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">each</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">ary</span>, <span style="color:#a6e22e">fn</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ret</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">l</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ary</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">l</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ary</span>[<span style="color:#a6e22e">i</span>];
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">ret</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fn</span>.<span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ret</span>;
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_listen</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>, <span style="color:#a6e22e">cache</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">cache</span>[<span style="color:#a6e22e">key</span>]) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cache</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">cache</span>[<span style="color:#a6e22e">key</span>].<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">fn</span>);
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_remove</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">cache</span>, <span style="color:#a6e22e">fn</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">cache</span>[<span style="color:#a6e22e">key</span>]) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fn</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cache</span>[<span style="color:#a6e22e">key</span>].<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">--</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">cache</span>[<span style="color:#a6e22e">key</span>][<span style="color:#a6e22e">i</span>] <span style="color:#f92672">===</span> <span style="color:#a6e22e">fn</span>) {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">cache</span>[<span style="color:#a6e22e">key</span>].<span style="color:#a6e22e">splice</span>(<span style="color:#a6e22e">i</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">cache</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_trigger</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cache</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_shift</span>.<span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">arguments</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_shift</span>.<span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">arguments</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">args</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arguments</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">_self</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ret</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">stack</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cache</span>[<span style="color:#a6e22e">key</span>];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">stack</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">stack</span>.<span style="color:#a6e22e">length</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">each</span>(<span style="color:#a6e22e">stack</span>, <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">apply</span>(<span style="color:#a6e22e">_self</span>, <span style="color:#a6e22e">args</span>);
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_create</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">namespace</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">namespace</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">namespace</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">_default</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cache</span> <span style="color:#f92672">=</span> {},
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">offlineStack</span> <span style="color:#f92672">=</span> [],
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 离线事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">ret</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">listen</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>, <span style="color:#a6e22e">last</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">_listen</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>, <span style="color:#a6e22e">cache</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">offlineStack</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">last</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;last&#34;</span>) {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">offlineStack</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">offlineStack</span>.<span style="color:#a6e22e">pop</span>()();
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">each</span>(<span style="color:#a6e22e">offlineStack</span>, <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>();
</span></span><span style="display:flex;"><span>              });
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">offlineStack</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">one</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>, <span style="color:#a6e22e">last</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">_remove</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">cache</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>, <span style="color:#a6e22e">last</span>);
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">remove</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">_remove</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">cache</span>, <span style="color:#a6e22e">fn</span>);
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">trigger</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fn</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">args</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">_self</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">_unshift</span>.<span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">arguments</span>, <span style="color:#a6e22e">cache</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">args</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arguments</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fn</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_trigger</span>.<span style="color:#a6e22e">apply</span>(<span style="color:#a6e22e">_self</span>, <span style="color:#a6e22e">args</span>);
</span></span><span style="display:flex;"><span>            };
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">offlineStack</span>) {
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">offlineStack</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">fn</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fn</span>();
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">namespace</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">?</span> <span style="color:#a6e22e">namespaceCache</span>[<span style="color:#a6e22e">namespace</span>]
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">?</span> <span style="color:#a6e22e">namespaceCache</span>[<span style="color:#a6e22e">namespace</span>]
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">:</span> (<span style="color:#a6e22e">namespaceCache</span>[<span style="color:#a6e22e">namespace</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">ret</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">:</span> <span style="color:#a6e22e">ret</span>;
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">create</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">_create</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">one</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>, <span style="color:#a6e22e">last</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">event</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">create</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">one</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>, <span style="color:#a6e22e">last</span>);
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">remove</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">event</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">create</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">remove</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>);
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">listen</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>, <span style="color:#a6e22e">last</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">event</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">create</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">fn</span>, <span style="color:#a6e22e">last</span>);
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">trigger</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">event</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">create</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">trigger</span>.<span style="color:#a6e22e">apply</span>(<span style="color:#66d9ef">this</span>, <span style="color:#a6e22e">arguments</span>);
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  })();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Event</span>;
</span></span><span style="display:flex;"><span>})();
</span></span></code></pre></div><h2 id="12-js实现发布-订阅模式的便利性">12. JS实现发布-订阅模式的便利性</h2>
<p>在JS中，我们用注册回调函数的形式来代替传统的发布-订阅模式，显得更加优雅和简单。</p>
<p>在JS中，我们无需去选择使用推模型还是拉模型。</p>
<ul>
<li>推模型是指在事件发生时，发布者一次性把所有更改的状态和数据都推送给订阅者。</li>
<li>拉模型是，发布者仅仅通知订阅者事件已经发生了，此外发布者要提供一些公共的接口供订阅者来主动拉取数据。拉模型的好处是可以让订阅者“按需获取”，但同时有可能让发布者变成一个“门户大开”的对象，同时增加了代码量和复杂度。</li>
</ul>
<p>在JS中，arguments可以很方便地表示参数列表，所以我们一般会选择推模型，使用Function.prototype.apply方法把所有参数都推送给订阅者。</p>
<h2 id="13-小结">13. 小结：</h2>
<p>优点：一为时间上的解耦，二为对象之间的解耦。</p>
<p>缺点：创建订阅者本身要消耗一定的时间和内存，而且当你订阅一个消息后，也许此消息最后都未发生，但这个订阅者会始终存在于内存中。另外，发布-订阅模式虽然可以弱化对象之间的联系，但如果过度使用的话，对象和对象之间的必要联系也将被深埋在背后，会导致程序难以跟踪维护和理解。</p>
<h2 id="source">Source</h2>
<p>JavaScript设计模式与开发实践：第8章 发布-订阅模式</p>
</div>
    </div>

        </div><script src="/js/highlight.min.js" />
<script>
    document.addEventListener("DOMContentLoaded", (event) => {
        document.querySelectorAll("pre").forEach((block) => {
            hljs.highlightBlock(block);
        });
    });
</script>
</body>
</html>
