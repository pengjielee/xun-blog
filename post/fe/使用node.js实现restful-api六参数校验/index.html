<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta
        name="viewport"
        content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="keywords" content="pengjielee,个人博客" />
    <meta name="description" content="Pengjielee的个人博客" />
    <title>Pengjielee&#39;s blog</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700" />
    <link rel="stylesheet" href="/css/style.css" />
</head>
<body><div id="main">
            <nav class="nav">
    <a href="/">首页</a> <span class="divide">|</span>
    <a href="/categories">分类</a>
    <span class="divide">|</span> <a href="/tags">标签</a>
    <span class="divide">|</span>
    <a href="/post">归档</a>
</nav>

    <div class="page-single">
        <header class="header">
            <h1 class="title"></h1><div class="post-meta">
    <div class="date">0001-01-01</div>
</div>
</header>
        <div class="content"><p>1、安装express-validator</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm install express-validator
</span></span></code></pre></div><p>2、修改src/routes/user.js</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>const express <span style="color:#f92672">=</span> require<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;express&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>const <span style="color:#f92672">{</span> header, body <span style="color:#f92672">}</span> <span style="color:#f92672">=</span> require<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;express-validator&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>const router <span style="color:#f92672">=</span> express.Router<span style="color:#f92672">()</span>;
</span></span><span style="display:flex;"><span>const Controller <span style="color:#f92672">=</span> require<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;../controllers/user&#39;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// 修改密码
</span></span><span style="display:flex;"><span>router.post<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;/changepwd&#34;</span>,
</span></span><span style="display:flex;"><span>  header<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Authorization&#34;</span><span style="color:#f92672">)</span>.exists<span style="color:#f92672">()</span>,
</span></span><span style="display:flex;"><span>  Controller.changePwd
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>router.post<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;/register&#34;</span>,
</span></span><span style="display:flex;"><span>  body<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;username&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    .isLength<span style="color:#f92672">({</span> min: <span style="color:#ae81ff">5</span> <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span>    .withMessage<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;用户名最小长度为5&#34;</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>  body<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;password&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    .isLength<span style="color:#f92672">({</span> min: <span style="color:#ae81ff">6</span> <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span>    .withMessage<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;密码最小长度为6&#34;</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>  Controller.register
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>module.exports <span style="color:#f92672">=</span> router;
</span></span></code></pre></div><p>3、修改src/controllers/user.js</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>const <span style="color:#f92672">{</span> validationResult <span style="color:#f92672">}</span> <span style="color:#f92672">=</span> require<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;express-validator&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exports.changePwd <span style="color:#f92672">=</span> async <span style="color:#f92672">(</span>req, res, next<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  const errors <span style="color:#f92672">=</span> validationResult<span style="color:#f92672">(</span>req<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>!errors.isEmpty<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> res.json<span style="color:#f92672">({</span> status: 0, message: errors.array<span style="color:#f92672">()</span> <span style="color:#f92672">})</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  res.json<span style="color:#f92672">({</span> status: 1, message: <span style="color:#e6db74">&#34;修改密码&#34;</span> <span style="color:#f92672">})</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exports.register <span style="color:#f92672">=</span> async <span style="color:#f92672">(</span>req, res, next<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  const errors <span style="color:#f92672">=</span> validationResult<span style="color:#f92672">(</span>req<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>!errors.isEmpty<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> res.json<span style="color:#f92672">({</span> status: 0, message: errors.array<span style="color:#f92672">()</span> <span style="color:#f92672">})</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  res.json<span style="color:#f92672">({</span> status: 1, message: <span style="color:#e6db74">&#34;注册成功&#34;</span> <span style="color:#f92672">})</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>;
</span></span></code></pre></div><p>4、测试
​</p>
<p>a. 注册接口</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST <span style="color:#e6db74">&#39;http://localhost:3000/api/user/register&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>返回：
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;status&#34;</span>:0,<span style="color:#e6db74">&#34;message&#34;</span>:<span style="color:#f92672">[{</span><span style="color:#e6db74">&#34;msg&#34;</span>:<span style="color:#e6db74">&#34;用户名最小长度为5&#34;</span>,<span style="color:#e6db74">&#34;param&#34;</span>:<span style="color:#e6db74">&#34;username&#34;</span>,<span style="color:#e6db74">&#34;location&#34;</span>:<span style="color:#e6db74">&#34;body&#34;</span><span style="color:#f92672">}</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;msg&#34;</span>:<span style="color:#e6db74">&#34;密码最小长度为6&#34;</span>,<span style="color:#e6db74">&#34;param&#34;</span>:<span style="color:#e6db74">&#34;password&#34;</span>,<span style="color:#e6db74">&#34;location&#34;</span>:<span style="color:#e6db74">&#34;body&#34;</span><span style="color:#f92672">}]}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -X POST <span style="color:#e6db74">&#39;http://localhost:3000/api/user/register&#39;</span> -d<span style="color:#e6db74">&#39;username=pengjielee&amp;password=123456&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>返回：
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;status&#34;</span>:1,<span style="color:#e6db74">&#34;message&#34;</span>:<span style="color:#e6db74">&#34;注册成功&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>b. 修改密码接口</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST <span style="color:#e6db74">&#39;http://localhost:3000/api/user/changepwd&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>返回：
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;status&#34;</span>:0,<span style="color:#e6db74">&#34;message&#34;</span>:<span style="color:#f92672">[{</span><span style="color:#e6db74">&#34;msg&#34;</span>:<span style="color:#e6db74">&#34;Invalid value&#34;</span>,<span style="color:#e6db74">&#34;param&#34;</span>:<span style="color:#e6db74">&#34;authorization&#34;</span>,<span style="color:#e6db74">&#34;location&#34;</span>:<span style="color:#e6db74">&#34;headers&#34;</span><span style="color:#f92672">}]}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -H <span style="color:#e6db74">&#39;Authorization: Bearer&#39;</span> -X POST <span style="color:#e6db74">&#39;http://localhost:3000/api/user/changepwd&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>返回：
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;status&#34;</span>:1,<span style="color:#e6db74">&#34;message&#34;</span>:<span style="color:#e6db74">&#34;修改密码&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div></div>
    </div>

        </div></body>
</html>
